# AGENTS.md — 德扑格局（微信小程序 + 云开发）

更新时间：2026-02-22

## 0. 你在这个仓库里的角色
你是这个项目的“安全、稳健、可回滚”的编码助手。  
默认用户是小白：输出要清晰、步骤要可验证、避免一次性大改。

> 交付标准：每次修改都要给出  
> 1) 改了哪些文件 2) 改动摘要 3) 怎么在微信开发者工具里验证 4) 可能的风险点与回滚方式

---

## 1. 项目概况（先理解，再动手）
- 产品：PokerNow 对局记录、数据分析与复盘工具（含 VPIP/PFR/AF、高阶指标、标签体系、玩家总榜）。
- 核心数据链路：`match_crawler -> match_hand_etl -> match_analysis`。
- 关键约束（不可破坏）：
  - **对局进行中（防作弊）**：隐藏对手真实身份，仅展示游戏昵称；用户只能看到自己绑定信息。
  - **对局结束（复盘）**：公开绑定关系，便于复盘交流。
  - **身份绑定系统**：支持“认领 + 多账号聚合”（多个临时昵称归属同一格局ID）。
  - **冠军命名权**：仅在满足“已结束 + 盈利第一名 + 未改名过”等条件下允许重命名，并自动加日期前缀。

---

## 2. 技术栈与目录结构（按项目当前事实）
### 技术栈
- 前端：微信小程序原生（WXML / WXSS / JS / JSON）
- 后端：微信云开发（Node.js 云函数）
- 数据库：云数据库（NoSQL）

### 当前目录结构（定位改动范围）
#### 目录结构可能继续演进，改动前先以仓库实际内容为准
- cloudfunctions/
  - `login/`、`user_manager/`
  - `match_manager/`（对局管理）
  - `match_crawler/`（日志抓取）
  - `match_hand_etl/`、`match_hand_etl_batch/`（基础事实层）
  - `match_analysis/`、`match_analysis_batch/`（聚合分析层）
  - `match_bind_tool/`（绑定逻辑）
  - `player_global_build/`、`player_global_query/`（玩家总榜构建/查询）
- miniprogram/
  - `pages/match/list`、`pages/match/detail`、`pages/match/bind`
  - `pages/player/index`、`pages/player/detail`
  - `pages/profile/index`
  - `styles/design-tokens.wxss`（全局设计 token）
- docs/
  - `frontend_design_spec.md`（前端统一设计规范）
- `project.config.json`（工程配置）

> 备注：`pages/match/add` 已移除，不要再作为入口页面使用。

---

## 3. 本项目默认工作方式（非常重要）
### 修改前
- 先用 2~5 句话说明计划、原因、风险点。
- 列出要改的文件清单（路径 + 目的）。
- 如果涉及新增依赖、改云环境配置、改数据库结构：先征得用户确认。

### 修改中
- 小步改动：尽量一次只解决一个问题，避免跨模块大改。
- 保持兼容：不轻易改变现有字段语义；如必须调整，给迁移方案和兼容处理。
- 样式改动默认走 token，不新增临时视觉体系。

### 修改后（必须提供）
- 变更摘要（3~8 条要点）
- 验证步骤（微信开发者工具可执行）
- 预期结果（用户能看到什么）
- 回滚方式（如何撤销这次改动）

---

## 4. 部署 / 运行 / 验证（给用户可执行清单）
### 基础配置
- 云环境 ID：在 `miniprogram/app.js` 配置 `env`。
- 云函数：每个 `cloudfunctions/*` 目录独立部署（云端安装依赖）。

### 云函数部署（稳妥方式）
- 微信开发者工具中右键对应云函数目录 → “上传并部署：云端安装依赖”。
- 涉及云函数改动时，部署后必须给出页面链路验证步骤（列表/详情/绑定/玩家）。

### 数据库（不要随意改集合名）
默认集合（若不存在需创建）：
- `matches`：对局元数据与账单
- `match_hands`：原始手牌日志
- `match_hand_facts`：ETL 后每手基础事实
- `match_player_bindings`：选手绑定关系
- `match_player_stats`：单局聚合分析结果
- `player_global_stats`：跨局玩家总榜
- `users`：用户资料

### 最小验收用例（每次改动至少跑相关项）
- 创建对局：粘贴 PokerNow 链接 -> 新建成功（列表出现）
- 对局详情：指标可展示（VPIP/PFR/AF 等），排序正常
- 身份绑定：进行中只能看自己的绑定；结束后可看完整绑定关系
- 玩家总榜：`刷新数据` 后，玩家列表与详情可加载
- 复制战绩：结束后可复制并粘贴到微信聊天

---

## 5. 编码规范与质量要求（小程序 / 云函数）
### 前端（miniprogram）
- 保持现有页面结构：WXML / WXSS / JS 分层，不引入新框架。
- UI 改动重点保护页面：`match/list`、`match/detail`、`match/bind`、`player/index`、`player/detail`。
- 优先 token 化：字号/间距/圆角/按钮尺寸尽量引用 `design-tokens.wxss`。

### 云函数（cloudfunctions）
- 所有入口参数必须校验：缺参返回明确错误信息（不要 silent fail）。
- 数据库读写需考虑幂等，避免重复调用写出脏数据。
- 批处理/全量任务优先分片执行（避免 3 秒超时）。
- 日志要可定位：打印关键上下文，但不要输出密钥、token、cookie。

### 隐私与安全（硬规则）
- 不提交真实密钥/Token；需要配置时使用占位并提示用户本地填写。
- 不执行破坏性操作（清库/批量删除/覆盖写）除非用户明确同意，且要提供回滚方案。

---

## 6. 前端设计规范（必须遵循）
- 统一规范文档：`docs/frontend_design_spec.md`
- 全局 token：`miniprogram/styles/design-tokens.wxss`
- 页面改动前后都要对照规范检查：
  - 配色语义
  - 字阶体系（5 档）
  - 间距（3 档）/ 圆角（3 档）/ 阴影层级
  - 按钮统一尺寸
  - 交互反馈（加载、空态、错误、危险确认）
  - 字距规则：默认 `letter-spacing: 0`（`--ls-0`），仅英文/ID 局部可用 `--ls-1`

若业务需要偏离规范，必须在改动说明中明确：
- 偏离原因
- 影响范围
- 回滚方案
