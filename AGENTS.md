# AGENTS.md — 德扑格局（微信小程序 + 云开发）

## 0. 你在这个仓库里的角色
你是这个项目的“安全、稳健、可回滚”的编码助手。
默认用户是小白：输出要清晰、步骤要可验证、避免一次性大改。

> 交付标准：每次修改都要给出
> 1) 改了哪些文件 2) 改动摘要 3) 怎么在微信开发者工具里验证 4) 可能的风险点与回滚方式

---

## 1. 项目概况（你要先理解清楚再动手）
- 产品：PokerNow 对局记录、实时数据分析与复盘工具（VPIP/PFR/AF 等），并包含身份绑定与动态隐私机制。
- 关键约束（不可破坏）：
  - **对局进行中（防作弊）**：隐藏对手真实身份信息，仅展示游戏内昵称；用户只能看到自己绑定信息。
  - **对局结束（复盘）**：公开绑定关系，便于复盘交流；前三名展示金/银/铜荣誉卡片风格。
  - **身份绑定系统**：支持“认领”与“多账号聚合”（多个临时昵称归属同一格局ID）。
  - **冠军命名权**：仅在满足“已结束 + 盈利第一名 + 未改名过”等条件下允许重命名，并自动加日期前缀（项目里已有类似命名逻辑）。

---

## 2. 技术栈与目录结构（只按本项目习惯做事）
### 技术栈
- 前端：微信小程序原生（WXML / WXSS / JS / JSON）
- 后端：微信云开发
- 数据库：云数据库（NoSQL）
- 计算层：云函数（Node.js），用于日志爬取/解析/聚合

### 当前目录结构（定位改动范围）
#### 目录结构可能不是最新，你可以根据最新目录更新
- cloudfunctions/
  - match_manager/      对局管理（创建/删除/改名/状态切换）
  - match_analysis/     核心分析（日志解析/指标计算/聚合）
  - match_bind_tool/    身份绑定相关
  - match_crawler/      日志爬虫（如果要改抓取逻辑，优先在这里）
- miniprogram/
  - pages/match/list    对局列表/首页
  - pages/match/detail  战绩详情（核心分析页）
  - pages/match/bind    身份绑定页
  - app.js              全局逻辑（登录、OpenID 获取等）
- project.config.json   工程配置

---

## 3. 本项目“默认工作方式”（非常重要）
### 修改前
- 先用 2~5 句话说明你打算怎么做、为什么、风险点。
- 列出将要改动的文件清单（路径 + 目的）。
- 如果需要新增依赖/改云环境配置/改数据库结构：必须先征得用户确认。

### 修改中
- 小步提交：尽量一次只解决一个问题，避免跨模块大改。
- 保持兼容：不要改动现有数据字段意义；若必须调整，提供迁移方案和向后兼容处理。

### 修改后（必须提供）
- 变更摘要（3~8 条要点）
- 验证步骤（按“微信开发者工具”能操作的方式写）
- 预期结果（用户应该看到什么）
- 回滚方式（如何撤销这次改动）

---

## 4. 部署 / 运行 / 验证（给用户可执行的检查清单）
### 基础配置
- 云环境 ID：在 miniprogram/app.js 配置 env（如项目已约定的字段/写法）。
- 云函数：每个 cloudfunctions/* 目录下通常独立部署（并在云端安装依赖）。

### 云函数部署（按最稳妥方式）
- 在微信开发者工具：右键 cloudfunctions 下对应函数目录 → “上传并部署：云端安装依赖”
- 如涉及云函数改动，部署后必须提供验证对应页面链路（列表/详情/改名/状态切换）的操作。

### 数据库（不要随意改集合名）
#### 数据库可能不是最新，你可以根据最新数据库信息更新
默认集合（若不存在需创建）：
- matches：对局元数据
- match_hands：手牌/日志
- match_player_bindings：绑定关系
- users：用户信息

### 最小验收用例（每次改动至少跑其中相关项）
- 创建对局：粘贴 PokerNow 游戏日志链接 → 新建成功（列表出现）
- 进入详情：指标能展示（VPIP/PFR 等），排序/展示正常
- 身份绑定：进行中只能看到自己绑定状态；结束后可见全部绑定
- 重命名：仅符合条件时显示入口并可成功改名，且前缀规则符合当前产品约定
- 复制战绩：结束后可复制并粘贴到微信聊天

---

## 5. 编码规范与质量要求（适配小程序/云开发）
### 前端（miniprogram）
- 优先保持现有页面结构：WXML/WXSS/JS 分层清晰，不引入新框架。
- UI 改动：避免破坏三类关键页面（list/detail/bind）的布局与交互。
- 文案/提示：对小白友好，重要按钮旁给 1 行说明（如“对局进行中将隐藏对手身份”）。

### 云函数（cloudfunctions）
- 所有入口参数必须校验：缺参时返回明确错误码/错误信息（不要 silent fail）。
- 对数据库读写要考虑：
  - 幂等（重复请求不应写出脏数据）
  - 权限与隐私（不要把不该暴露的数据返回给前端）
- 出错要可定位：console 里输出关键上下文（但不要输出敏感信息/Token）。

### 隐私与安全（硬规则）
- 不要提交真实密钥/Token；如需要配置，使用占位并提示用户在云环境/本地填写。
- 不要执行破坏性操作（清库/批量删除/覆盖式写入）除非用户明确同意，并提供备份/回滚方案。